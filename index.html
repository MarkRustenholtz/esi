<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Application ESI + Assistant Visa</title>
<link rel="manifest" href="/esi/manifest.json">
<meta name="theme-color" content="#0d6efd">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
    h1 { text-align: center; }
    nav { text-align: center; margin-bottom: 20px; }
    nav button {
        margin: 5px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #004080;
        color: white;
        cursor: pointer;
    }
    nav button.active { background-color: #0066cc; }
    section { display: none; }
    section.active { display: block; }

    /* Styles Fiche ESI */
    h2 { background-color: #004080; color: white; padding: 10px; border-radius: 5px; }
    form { background: white; padding: 20px; border-radius: 5px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 10px; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .btn-danger { background-color: #cc0000; color: white; }
    .btn-danger:hover { background-color: #ff3333; }
    form button { background-color: #004080; color: white; }
    form button:hover { background-color: #0066cc; }
    .fiche { background: white; padding: 10px; border-radius: 5px; margin-top: 10px; }
    .date-naissance { display: flex; gap: 5px; }
    .date-naissance input { flex: 1; }
    #piecesIdentite {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px 20px;
    }
    #piecesIdentite label {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* Styles Assistant Visa */
    #visaApp { background: white; padding: 20px; border-radius: 5px; max-width: 600px; margin: auto; }
    #visaApp h2 { background: none; color: #0055A4; }
    #visaApp select, #visaApp button { margin: 5px 0; padding: 5px; font-size: 1rem; }
    #resultat { margin-top: 15px; font-weight: bold; }
    #visaApp a { color: #0055A4; text-decoration: none; }
    #visaApp a:hover { text-decoration: underline; }
</style>
</head>
<body>

<h1>Application ESI & Assistant Visa France</h1>

<nav>
  <button onclick="showSection('esi')" id="btnEsi" class="active">Fiche ESI</button>
  <button onclick="showSection('visa')" id="btnVisa">Assistant Visa France</button>
  <button onclick="window.open('https://markrustenholtz.github.io/borderforce/', '_blank')">
  App principal
</button>
</nav>

<!-- Section Fiche ESI -->
<section id="esi" class="active">
  <form id="ficheForm">
      <h2>Identité</h2>
      <label>Nom<input type="text" id="nom" autocomplete="off" required></label>
      <label>Prénom<input type="text" id="prenom" autocomplete="off" required></label>
      <label>Sexe
          <select id="sexe">
              <option value="">--Sélectionner--</option>
              <option value="Masculin">Masculin</option>
              <option value="Féminin">Féminin</option>
              <option value="Autre">Autre</option>
          </select>
      </label>
      <label>Nationalité<input type="text" id="nationalite" autocomplete="off"></label>
      
      <label>Date de naissance :</label>
      <div class="date-naissance">
          <input type="number" id="jour" placeholder="JJ" min="1" max="31" required>
          <input type="number" id="mois" placeholder="MM" min="1" max="12" required>
          <input type="number" id="annee" placeholder="AAAA" min="1900" max="2100" required>
      </div>
      <label>Âge<input type="number" id="age" readonly></label>

      <h2>Voyage</h2>
      <label>Ville de départ<input type="text" id="villeDepart" autocomplete="off"></label>
      <label>Pays de départ<input type="text" id="paysDepart" autocomplete="off"></label>
      <label>Ville de destination<input type="text" id="villeDestination" autocomplete="off"></label>
      <label>Pays de destination<input type="text" id="paysDestination" autocomplete="off"></label>

      <h2>Intervention</h2>
      <label>Heure et Date<input type="text" id="heureDate" readonly></label>
      <label>Lieu d'interpellation<input type="text" id="lieuInterpellation" autocomplete="off"></label>

      <h2>Véhicule</h2>
      <label>Type de véhicule<input type="text" id="vehicule" autocomplete="off"></label>
      <label>Immatriculation<input type="text" id="immatriculation" autocomplete="off"></label>

      <h2>Pièces d'identité présentées</h2>
      <div id="piecesIdentite">
          <label><input type="checkbox" name="piece" value="Passeport valide"> Passeport valide</label>
          <label><input type="checkbox" name="piece" value="Passeport périmé"> Passeport périmé</label>
          <label><input type="checkbox" name="piece" value="Fiche de demande d'asile valide"> Fiche de demande d'asile valide</label>
          <label><input type="checkbox" name="piece" value="Fiche de demande d'asile périmée"> Fiche de demande d'asile périmée</label>
          <label><input type="checkbox" name="piece" value="Carte d'identité valide"> Carte d'identité valide</label>
          <label><input type="checkbox" name="piece" value="Carte d'identité périmée"> Carte d'identité périmée</label>
          <label><input type="checkbox" name="piece" value="Titre de séjour valide"> Titre de séjour valide</label>
          <label><input type="checkbox" name="piece" value="Titre de séjour périmé"> Titre de séjour périmé</label>
      </div>

      <button type="submit">Enregistrer la fiche</button>
  </form>

  <h2>Historique des fiches</h2>
  <div id="historique"></div>
  <button id="effacerFiches" class="btn-danger">Effacer toutes les fiches</button>
</section>

<!-- Section Assistant Visa -->
<section id="visa">
  <div id="visaApp">
    <h2>Mini Assistant Visa France</h2>
    <label for="pays">Sélectionnez votre pays :</label><br>
    <select id="pays">
      <option value="">--Choisissez un pays--</option>
    </select><br>

    <label for="duree">Type de séjour :</label><br>
    <select id="duree">
      <option value="court">Courte durée (&lt;90 jours)</option>
      <option value="long">Longue durée (&gt;90 jours)</option>
    </select><br>

    <button onclick="verifierVisa()">Vérifier</button>
    <p id="resultat"></p>
  </div>
</section>

<script>
// --------- NAVIGATION ----------
function showSection(id) {
  document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
  document.getElementById("btn" + id.charAt(0).toUpperCase() + id.slice(1)).classList.add("active");
}

// --------- SCRIPT FICHE ESI ----------
function setHeureDate() {
    const now = new Date();
    const h = now.getHours().toString().padStart(2,'0');
    const m = now.getMinutes().toString().padStart(2,'0');
    const s = now.getSeconds().toString().padStart(2,'0');
    const j = now.getDate().toString().padStart(2,'0');
    const mois = (now.getMonth()+1).toString().padStart(2,'0');
    const a = now.getFullYear();
    document.getElementById('heureDate').value = `${h}:${m}:${s} - ${j}/${mois}/${a}`;
}
setHeureDate();
setInterval(setHeureDate, 1000);

function calculerAge() {
    const jour = parseInt(document.getElementById("jour").value);
    const mois = parseInt(document.getElementById("mois").value) - 1;
    const annee = parseInt(document.getElementById("annee").value);
    if (!jour || !mois || !annee) return;
    const today = new Date();
    const naissance = new Date(annee, mois, jour);
    let age = today.getFullYear() - naissance.getFullYear();
    const m = today.getMonth() - naissance.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < naissance.getDate())) age--;
    document.getElementById("age").value = age;
}
function autoNext(input, nextInputId, maxLength) {
    input.addEventListener('input', function() {
        if (this.value.length >= maxLength) {
            document.getElementById(nextInputId).focus();
        }
        calculerAge();
    });
}
autoNext(document.getElementById('jour'), 'mois', 2);
autoNext(document.getElementById('mois'), 'annee', 2);
document.getElementById('annee').addEventListener('input', calculerAge);
document.getElementById('immatriculation').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});

document.getElementById('ficheForm').addEventListener('submit', function(e){
    e.preventDefault();
    const pieces = Array.from(document.querySelectorAll('input[name="piece"]:checked')).map(cb => cb.value);
    const fiche = {
        nom: document.getElementById('nom').value,
        prenom: document.getElementById('prenom').value,
        sexe: document.getElementById('sexe').value,
        nationalite: document.getElementById('nationalite').value,
        jour: document.getElementById('jour').value,
        mois: document.getElementById('mois').value,
        annee: document.getElementById('annee').value,
        age: document.getElementById('age').value,
        villeDepart: document.getElementById('villeDepart').value,
        paysDepart: document.getElementById('paysDepart').value,
        villeDestination: document.getElementById('villeDestination').value,
        paysDestination: document.getElementById('paysDestination').value,
        heureDate: document.getElementById('heureDate').value,
        lieuInterpellation: document.getElementById('lieuInterpellation').value,
        vehicule: document.getElementById('vehicule').value,
        immatriculation: document.getElementById('immatriculation').value,
        piecesIdentite: pieces
    };
    const fiches = JSON.parse(localStorage.getItem('fichesESI') || '[]');
    fiches.push(fiche);
    localStorage.setItem('fichesESI', JSON.stringify(fiches));
    this.reset();
    setHeureDate();
    afficherHistorique();
});

function afficherHistorique() {
    const historiqueDiv = document.getElementById('historique');
    historiqueDiv.innerHTML = '';
    const fiches = JSON.parse(localStorage.getItem('fichesESI') || '[]');
    fiches.forEach((fiche, index) => {
        const ficheDiv = document.createElement('div');
        ficheDiv.className = 'fiche';
        ficheDiv.innerHTML = `
            <strong>Fiche #${index+1}</strong><br>
            Nom: ${fiche.nom} ${fiche.prenom} | Sexe: ${fiche.sexe} | Nationalité: ${fiche.nationalite} | Âge: ${fiche.age}<br>
            Départ: ${fiche.villeDepart}, ${fiche.paysDepart} | Destination: ${fiche.villeDestination}, ${fiche.paysDestination}<br>
            Heure et Date: ${fiche.heureDate} | Lieu: ${fiche.lieuInterpellation}<br>
            Véhicule: ${fiche.vehicule} | Immatriculation: ${fiche.immatriculation}<br>
            Pièces d'identité: ${fiche.piecesIdentite.join(", ")}<br>
            <button onclick="modifierFiche(${index})">Modifier</button>
            <button onclick="supprimerFiche(${index})" class="btn-danger">Supprimer</button>
        `;
        historiqueDiv.appendChild(ficheDiv);
    });
}
function supprimerFiche(index) {
    if (confirm("Voulez-vous vraiment supprimer cette fiche ?")) {
        const fiches = JSON.parse(localStorage.getItem('fichesESI') || '[]');
        fiches.splice(index, 1);
        localStorage.setItem('fichesESI', JSON.stringify(fiches));
        afficherHistorique();
    }
}
function modifierFiche(index) {
    const fiches = JSON.parse(localStorage.getItem('fichesESI') || '[]');
    const fiche = fiches[index];
    document.getElementById('nom').value = fiche.nom;
    document.getElementById('prenom').value = fiche.prenom;
    document.getElementById('sexe').value = fiche.sexe;
    document.getElementById('nationalite').value = fiche.nationalite;
    document.getElementById('jour').value = fiche.jour;
    document.getElementById('mois').value = fiche.mois;
    document.getElementById('annee').value = fiche.annee;
    document.getElementById('age').value = fiche.age;
    document.getElementById('villeDepart').value = fiche.villeDepart;
    document.getElementById('paysDepart').value = fiche.paysDepart;
    document.getElementById('villeDestination').value = fiche.villeDestination;
    document.getElementById('paysDestination').value = fiche.paysDestination;
    document.getElementById('lieuInterpellation').value = fiche.lieuInterpellation;
    document.getElementById('vehicule').value = fiche.vehicule;
    document.getElementById('immatriculation').value = fiche.immatriculation;
    document.querySelectorAll('input[name="piece"]').forEach(cb => cb.checked = false);
    fiche.piecesIdentite.forEach(val => {
        const cb = Array.from(document.querySelectorAll('input[name="piece"]')).find(c => c.value === val);
        if (cb) cb.checked = true;
    });
    fiches.splice(index, 1);
    localStorage.setItem('fichesESI', JSON.stringify(fiches));
    afficherHistorique();
}
document.getElementById('effacerFiches').addEventListener('click', function() {
    if (confirm("Voulez-vous vraiment effacer toutes les fiches ?")) {
        localStorage.removeItem('fichesESI');
        afficherHistorique();
        alert("Toutes les fiches ont été effacées !");
    }
});
afficherHistorique();


/* ---------- BLOC JS COMPLET POUR ESI+VISA (195 pays) ---------- */
/* Utilisation : garde ta balise <select id="pays"> et les éléments d'UI existants.
   Le script peuple le select, trie alphabétiquement et gère visaData.court / visaData.long. */

(function(){
  // 1) Liste d'environ 195 pays (UN members + micro-États utiles)
  const allCountries = [
    "Afghanistan","Albanie","Algérie","Allemagne","Andorre","Angola","Antigua-et-Barbuda","Argentine","Arménie","Australie",
    "Autriche","Azerbaïdjan","Bahamas","Bahreïn","Bangladesh","Barbade","Biélorussie","Belgique","Belize","Bénin",
    "Bhoutan","Bolivie","Bosnie-Herzégovine","Botswana","Brésil","Brunei","Bulgarie","Burkina Faso","Burundi","Cabo Verde",
    "Cambodge","Cameroun","Canada","République centrafricaine","Tchad","Chili","Chine","Colombie","Comores","Congo",
    "République démocratique du Congo","Costa Rica","Côte d'Ivoire","Croatie","Cuba","Chypre","République tchèque","Danemark","Djibouti","Dominique",
    "République dominicaine","Équateur","Égypte","El Salvador","Guinée équatoriale","Érythrée","Estonie","Eswatini","Éthiopie","Fidji",
    "Finlande","France","Gabon","Gambie","Géorgie","Ghana","Grèce","Grenade","Guatemala",
    "Guinée","Guinée-Bissau","Guyana","Haïti","Honduras","Hongrie","Islande","Inde","Indonésie","Iran",
    "Irak","Irlande","Israël","Italie","Jamaïque","Japon","Jordanie","Kazakhstan","Kenya","Kiribati",
    "Koweït","Kirghizistan","Laos","Lettonie","Liban","Lesotho","Liberia","Libye","Liechtenstein","Lituanie",
    "Luxembourg","Macédoine du Nord","Madagascar","Malawi","Malaisie","Maldives","Mali","Malte","Îles Marshall","Mauritanie",
    "Maurice","Mexique","Micronésie","Moldavie","Monaco","Mongolie","Monténégro","Maroc","Mozambique","Myanmar",
    "Namibie","Nauru","Népal","Pays-Bas","Nouvelle-Zélande","Nicaragua","Niger","Nigéria","Corée du Nord","Norvège",
    "Oman","Pakistan","Palaos","Panama","Papouasie-Nouvelle-Guinée","Paraguay","Pérou","Philippines","Pologne","Portugal",
    "Qatar","Roumanie","Russie","Rwanda","Saint-Kitts-et-Nevis","Sainte-Lucie","Saint-Vincent-et-les-Grenadines","Samoa","Saint-Marin","Sao Tomé-et-Principe",
    "Arabie Saoudite","Sénégal","Serbie","Seychelles","Sierra Leone","Singapour","Slovaquie","Slovénie","Îles Salomon","Somalie",
    "Afrique du Sud","Corée du Sud","Soudan du Sud","Espagne","Sri Lanka","Soudan","Suriname","Suède","Suisse","Syrie",
    "Taïwan","Tadjikistan","Tanzanie","Thaïlande","Timor-Leste","Togo","Tonga","Trinité-et-Tobago","Tunisie","Turquie",
    "Turkménistan","Tuvalu","Ouganda","Ukraine","Émirats arabes unis","Royaume-Uni","États-Unis","Uruguay","Ouzbékistan","Vanuatu",
    "Vatican","Venezuela","Vietnam","Yémen","Zambie","Zimbabwe","Kosovo"
  ];

  // 2) Pays sans visa court ni long : UE (27) + EEE + Suisse + micro-États
  const neverNeed = [
    // UE (francisé) - 27
    "Autriche","Belgique","Bulgarie","Chypre","République tchèque","Croatie","Danemark","Estonie","Finlande","France",
    "Allemagne","Grèce","Hongrie","Irlande","Italie","Lettonie","Lituanie","Luxembourg","Malte","Pays-Bas",
    "Pologne","Portugal","Roumanie","Slovaquie","Slovénie","Espagne","Suède",
    // EEE + Suisse + micro-États
    "Islande","Liechtenstein","Norvège","Suisse","Monaco","Andorre","Saint-Marin","Vatican"
  ];

  // 3) Pays exemptés de visa court séjour (Annex II / liste commune des Etats) -> véhicule "shortExempt"
  // Source : règles communes Schengen / France-Visas (liste Annex II / ETIAS countries). C'est la règle générale (confirmer cas particuliers).
  const shortExempt = [
    // Europe non-UE (biométrique souvent requis)
    "Albanie","Bosnie-Herzégovine","Monténégro","Macédoine du Nord","Serbie","Moldavie","Ukraine","Géorgie",
    // Amériques
    "Argentine","Bahamas","Barbade","Bolivie","Brésil","Canada","Chili","Colombie","Costa Rica",
    "Dominique","Équateur","El Salvador","Grenade","Guatemala","Guyana","Honduras","Jamaïque","Mexique",
    "Nicaragua","Panama","Paraguay","Pérou","Suriname","Trinité-et-Tobago","Uruguay","Venezuela",
    // Asie-Pacifique & Moyen-Orient
    "Australie","Brunei","Japon","Malaisie","Nouvelle-Zélande","Singapour","Corée du Sud","Israël","Taïwan",
    "Hong Kong","Macao","Timor-Leste","Émirats arabes unis",
    // Océanie
    "Kiribati","Îles Marshall","Micronésie","Nauru","Palaos","Samoa","Îles Salomon","Tonga","Tuvalu","Vanuatu",
    // Afrique / Océan Indien (quelques exceptions)
    "Île Maurice","Seychelles"
  ];

  // Normalisation : s'assurer que tous les noms présents dans neverNeed/shortExempt figurent dans allCountries
  const missing = [];
  [ ...neverNeed, ...shortExempt ].forEach(n => { if (!allCountries.includes(n)) missing.push(n); });
  // (on ne stoppe pas, on assume que la majorité est cohérente)

  // 4) Construction de visaData
  const visaData = { court: {}, long: {} };

  allCountries.forEach(country => {
    if (neverNeed.includes(country)) {
      visaData.court[country] = false; // pas de visa court
      visaData.long[country] = false;  // pas de visa long
    } else if (shortExempt.includes(country)) {
      visaData.court[country] = false; // pas de visa court
      visaData.long[country] = true;   // mais visa long requis
    } else {
      visaData.court[country] = true;  // visa requis pour court séjour
      visaData.long[country] = true;   // visa requis pour long séjour
    }
  });

  // 5) Optionnel : préciser les pays qui exigent passeport biométrique pour l'exemption court séjour
  // (exemples : Serbie, Albanie, Bosnie, Macédoine du Nord, Moldavie, Ukraine, Géorgie)
  const biometricExemptions = ["Albanie","Bosnie-Herzégovine","Macédoine du Nord","Monténégro","Serbie","Moldavie","Ukraine","Géorgie"];

  // 6) Remplissage du select trié alphabétiquement
  const selectPays = document.getElementById('pays');
  if (!selectPays) {
    console.warn("Element <select id='pays'> introuvable — crée-le dans ton HTML.");
  } else {
    // trier pays (respecter accents)
    const sorted = allCountries.slice().sort((a,b)=> a.localeCompare(b,'fr',{ignorePunctuation:true}));
    sorted.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      selectPays.appendChild(opt);
    });
  }

  // 7) Fonction de vérification (réutilise ton HTML existant : input #duree doit valoir 'court' ou 'long')
  window.verifierVisa = function() {
    const pays = (document.getElementById('pays') || {}).value;
    const duree = (document.getElementById('duree') || {}).value; // 'court' ou 'long'
    const resultat = document.getElementById('resultat');
    if (!resultat) {
      alert("Element #resultat non trouvé. Assure-toi d'avoir un conteneur pour afficher le résultat.");
      return;
    }
    if (!pays) { resultat.textContent = "Veuillez sélectionner un pays."; return; }
    if (!['court','long'].includes(duree)) { resultat.textContent = "Veuillez choisir une durée ('court' ou 'long')."; return; }

    const needsVisa = visaData[duree][pays];
    let html = '';
    if (needsVisa) {
      html = `Visa requis pour ce séjour (${duree === 'court' ? 'court (<90j)' : 'long (>90j)'}). ` +
             `Voir la procédure sur <a href="https://france-visas.gouv.fr/web/france-visas/assistant-visa" target="_blank" rel="noopener">France-Visas</a>.`;
    } else {
      html = `Pas de visa requis pour ce séjour (${duree === 'court' ? 'court (<90j)' : 'long (>90j)'}). ` +
             `Vérifier conditions particulières (type de passeport, ETIAS, accords bilatéraux) sur <a href="https://france-visas.gouv.fr/web/france-visas/assistant-visa" target="_blank" rel="noopener">France-Visas</a>.`;
    }

    // précision si exemption court dépend de passeport biométrique
    if (!needsVisa && duree === 'court' && biometricExemptions.includes(pays)) {
      html += ` <br><small>Note : l'exemption peut demander un passeport biométrique.</small>`;
    }
    resultat.innerHTML = html;
  };

  // 8) Expose les données si tu veux les utiliser ailleurs (console.debug)
  window._esiVisaData = { allCountries, neverNeed, shortExempt, visaData, biometricExemptions };

  // debug log
  console.debug("ESI+Visa: visaData initialisé pour", allCountries.length, "pays. Voir window._esiVisaData.");
})();

</script>

</body>
</html>
